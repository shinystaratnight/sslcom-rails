<%certificate ||= @certificate_order.certificate if @certificate_order%>
<script type="text/javascript">
jQuery.noConflict();
jQuery(function($) {
  var show_new_user_section=true;
  var count = []; //used to map existing cart items with reindexed cookies
  $(document).keypress(function (e) {
    var key = e.which;
    if(key == 13)  // the enter key code
    {
      $('#auto_adjust input[name=next]').click(); //Next button
      return false;
    }
  });
  $.line_item_total = function(id){
    qty=$('span[id^=qty_'+id+']').length > 0 ? $('[id^=qty_'+id+']').text() :
      $('[id^=qty_'+id+']').val();
    total_str=$('[id^=total_'+id+']').text();
    price=$('[id^=price_'+id+']').text().match(/[\d\.\,]+/)
    price=price.toString().replace(/,/,'');
    total=qty*price;
    total_str=total_str.replace(/[\d\.\,]+/, total.toFixed(2).toString());
    $('[id^=total_'+id+']').text(total_str);
    $.adjust_cart_total();
  };
  $.adjust_cart_total = function(){
    total = 0;
    $('[id^=total_]').each(function(){
      total += parseFloat($.toMoneyFloat($(this).text()));
    });
    total=(total!=0)?total.toFixed(2).toString():"0.00";
    $('#cart_total').text('$'+total+" USD");
  };
  $.update_cart_qty_display = function(){
    qty=$('[id^=remove_]').length;
    $('#cart_count').text($('#cart_count').text().replace(/\d+/,qty));
    $('#cart_items_qty').text($('#cart_items_qty').text().replace(/\d+/,qty));
    if(qty==1)
      $('#cart_items_qty').text($('#cart_items_qty').text().replace(/[a-zA-Z]+/,'item'));
    else
      $('#cart_items_qty').text($('#cart_items_qty').text().replace(/[a-zA-Z]+/,'items'));
    $('#cart_count').text($('#cart_count').text().replace(/[a-zA-Z]+/,''));
    $('#cart_items_qty', '.icn_cart').effect("highlight", {color:'green'}, 500);
  };
  $.change_cart_items_qty = function(quantity, indx){
    cart = $.get_cart_items();
    //structure of a certificate order in the cart is as follows
    //product,num_years,num_servers,domains,quantity:
    $(count).each(function(index, value){
      if(value==indx){
        indx=index;
      }
    });
    if(quantity>0)
      cart[indx]["<%=ShoppingCart::QUANTITY%>"]=quantity;
    else{
      count.remove(indx);
      cart.remove(indx);
    }
    $.save_cart(cart);
  };
  $(document).ready(function() {
    <%=render partial: 'billing_profiles/profile_scripts'%>
    $('.dropdown, .validation_status_message, .expand, .subject_column > a').click(function(){
      if($(this).parents().filter('tr').next().css('display')!='none'){
        $(this).parents().filter('tr').next().css('display', 'none');
        $(this).parents().filter('tr').find('.dropdown img').attr('src',"<%= asset_path('expand.png') %>");
        $(this).parents().filter('tr').find('.expand').text('expand');
        this.expanded = false;
      }
      else{
        this.expanded = true;
        $(this).parents().filter('tr').find('.dropdown img').attr('src',"<%= asset_path('contract.png') %>");
        $(this).parents().filter('tr').next().show();
        $(this).parents().filter('tr').find('.expand').text('close');
      }
    });
    $('textarea').click(function(){
      $(this).select();
    });
    $('.has_account_container').click(function(){
      $(this).siblings().filter(':radio[name*=has_account]').click();
    });
    $(':radio[name*=has_account]').click(function(){
      if($(this).val()=="true"){
        show_new_user_section=false;
        $('#billing_section').hide();
        $('#new_user_section').hide();
        $('#login_section').show();
        <%if certificate -%>
        $('#subscriber_agreement').hide();
        <%end%>
      }
      else{
        show_new_user_section=true;
        $('#billing_section').show();
        $('#new_user_section').show();
        $('#login_section').hide();
        <%if certificate -%>
        $('#subscriber_agreement').show();
        <%end%>
      }
    });
    $(':radio[name*=has_account][value=false]').click();
    // prepare Options Object
    var options = {
        dataType: 'json',
        url: '<%=user_session_path%>',
        beforeSubmit: function(){
          $('div[id*=Explanation][class*=Explanation]').remove();
          $('#waiting_bar').show();
        },
        success: function(data, status, $form) {
          $('#waiting_bar').hide();
          if(typeof(data.record) == "undefined"){
            errorArray=[];
            msg="Login error(s):\n";
            if(typeof(data.errors) != "undefined"){
              for (var key in data.errors) {
                if (data.errors.hasOwnProperty(key)) {
                  errorArray.push(key + ": " + data.errors[key].join(", "));
                }
              }
            }
            else if (typeof(data.duplicate_v2_user) != "undefined"){
              errorArray.push(
                 "Ooops, '"+data.duplicate_v2_user.login+"' has been consolidated with a primary account. Please contact support@ssl.com for assistance or more information.");
            }
            errorString = errorArray.join(",\n");
            alert(msg+errorString);
          }
          else{
            if(data.record.user.status=='disabled')
              alert('This account has been disabled');
            else if(data.record.user.status=='enabled'){
              if(data.redirect_method=='submit'){
                  if(data.url)
                    $('form#new_order').attr("action", data.url);
                  $('form#new_order').submit();
              }
              else if(data.redirect_method=='redirect')
                window.location=data.url;
              else{
                //leave only billing fields showing
                $('#billing_section').show();
                $('#subscriber_agreement').show();
                $('#login_section, #new_user_section').add($('.radio_choices').parent()).remove();
                var status_bar = $("<div class='flash_message close'></div>");
                status_bar.hide();
                $('.reseller_registration_select_tier').before(status_bar);
                status_bar.addClass('notice').append("<span>Successfully logged in.</span>");
                status_bar.fadeIn();
                $('.user_session').html('<%=link_to "Logout", logout_url%>');
                if(data.billing_profiles){
                  $('#stylized.deposit_funds_form').prepend(data.billing_profiles);
                  profile_form_hidden = <%=!initial_display?.empty?%>;
                  if(profile_form_hidden == false){
                    $('#register_card_form').fadeOut();
                    $(this).add('img[id=toggle_billing_profile_form]').attr('src', "<%= asset_path('add_new_billing_profile.png') %>");
                    $(':radio[id*='+profile_id+']').attr("checked","checked");
                    profile_form_hidden = true;
                  }
                }
              }
              return true;
            }
          }
          $(':password').clearFields();
        }
    };
    $('input:image').livequery('click', function(){
      if($(':radio[name*=has_account]:checked').val()=="true" && 
          $(this).attr('name')=='next'){
        $('form#new_order').ajaxSubmit(options);
        // return false to prevent normal browser submit and page navigation
        return false;
      }
    });
    $('select[id^=qty_]').change(function(){
      id=$(this).attr("id").match(/\d+$/)[0];
      $.line_item_total(id);
      $.change_cart_items_qty(qty, id);
    });
    $('span[id^=remove_]').click(function(event, no_cart_qty_update){
      id=$(this).attr("id").match(/\d+$/)[0];
      $('tr[class$='+id+']').fadeOut();
      $('tr[class$='+id+']').remove();
      $.adjust_cart_total();
      $.change_cart_items_qty(0, id);
      if(no_cart_qty_update==null){
        if(count.length==0)
          $('span#clear_cart').triggerHandler('click');
        else
          $.update_cart_qty_display();
      }
    });
    $('span#clear_cart').click(function(){
      $(count).each(function(index, value){
        $('span[id^=remove_'+value+']').triggerHandler('click', true);
      });
      $('a#shop_more_img').html('<%=image_tag('add_items.gif')%>');
      $('a#checkout_img').remove();
      $('#clear_cart').parents().filter('tr').remove();
      $('#shop_more_checkout').attr('id', 'add_items');
      $('.empty_cart_desc').show();
      $.empty_out_cart();
      $.update_cart_qty_display();
    });
    $('select[id^=qty_]').each(function(index, value){
      //used for mapping when line items get deleted
      count.push(index);
      id=$(this).attr("id").match(/\d+$/);
      $.line_item_total(id);
    });
    $('#register_card_form').live('click', function(){
      $(':radio[name=funding_source]').removeAttr('checked');
    });
    $(':radio[name=funding_source]').live('click', function(){
      $('#register_card_form').fadeOut();
      $('img[id=toggle_billing_profile_form]').attr('src', "<%= asset_path('add_new_billing_profile.png') %>");
      profile_form_hidden = true;
    });
    $("button[name=apply_discount]").bind("click", function() {
      var discount_code = $('#discount_code').val();
      if(discount_code==""){
        $('span#discount_applied,span#invalid_discount_code').remove();
        $('div#tier_load_amount').text(old_total_text);
        return;
      }
      $.ajax({
        url: "<%=lookup_discount_orders_url%>",
        data: {discount_code: discount_code},
        type: "POST",
        success: function(data, status){
          $('span#discount_applied,span#invalid_discount_code').remove();
          $('div#tier_load_amount').text(old_total_text);
          if((typeof data.discount != 'undefined')){
            apply = parseFloat(data.discount.value);
            old_total = parseFloat($.toMoneyFloat($('div#tier_load_amount').text()));
            if(data.discount.apply_as=='absolute')
              discount = apply * .01;
            else
              discount = old_total * apply;
            new_total = old_total - discount;
                    $('div#tier_load_amount').text('$'+new_total.toFixed(2).toString()+" USD");
            if($('span#discount_applied').length==0)
              var cur_discount = (discount).toFixed(2);
              $('div#tier_load_amount').after("<span id='discount_applied'>"+data.discount.label+" applied (-$"+cur_discount.toString()+" USD)</span>");
              $('span#discount_applied').data('discount', cur_discount);
              $('span#discount_applied').data('discount_code', discount_code);
              if ($('#payment_method_paypal, #funding_source_paypal').is(':checked')) {
                $('[name*=paypal]').attr('href',
                  "<%= paypal_express_checkout_url(ssl_slug: params[:ssl_slug]) %>"
                    +'?discount='+cur_discount+'&discount_code='+discount_code);
              }
          }
          else if($('#discount_code').val()!=""){
            $('label[for=discount_code]').append("<span class='label_desc' id='invalid_discount_code'>invalid discount code</span>");
          }
        }
      });
    });
    $.adjust_cart_total();
    old_total_text=$('div#tier_load_amount').text();
  });
});
</script>
