var profile_id = "";
profile_form_hidden = <%=!initial_display?.empty?%>;
$.last_delete_clicked=function(){
  if($('.delete_billing_profile').size() <= 1)
    $('.funding_sources_head, #existing_credit_cards').empty();
  $('#register_card_form').fadeIn();
};

function paypalCheckoutUrl() {
  var url = "<%= paypal_express_checkout_url(ssl_slug: params[:ssl_slug]) %>",
      discount = $('span#discount_applied'),
      reprocess_ucc = $('#reprocess_ucc_amount');
  
  if (discount.length && discount.data('discount') && discount.data('discount_code')) {
    url +='?discount='+discount.data('discount')+'&discount_code='+discount.data('discount_code');
  }
  
  if (reprocess_ucc.length) {
    url +='?amount=' + $('#order_order_amount').val()
        + '&funded_target=' + $('#order_charge_amount').val()
        + '&funded_account=' + $('#order_funded_amount').val()
        + '&deduct_order=true'
        + '&reprocess_ucc=true'
        + '&order_type=order'
        + '&co_ref=' + reprocess_ucc.data('co-ref')
        + '&cc_ref=' + reprocess_ucc.data('cc-ref');
  }
  $('[name*=paypal]').attr('href', url);
  return url;
}

$('#payment_method_paypal, #funding_source_paypal').on('click', function(){
  if($('#payment_method_paypal, #funding_source_paypal').is(':checked')){
    $('form#new_order').attr('action', paypalCheckoutUrl());
  }
});

$('#expand_register_card').live('click', function(){
  if(profile_form_hidden){
    $.profileRequiredToggle('enable');
    $('#register_card_form').fadeIn();
    $(this).add('img[id=toggle_billing_profile_form]').attr('src', "<%= asset_path('hide_billing_profile_form.png') %>");
    profile_id = $(':radio[name*=funding_source]:checked').attr("id");
    $(':radio[name*=funding_source]').removeAttr('checked');
    profile_form_hidden = false;
  }
  else{
    $('#register_card_form').fadeOut();
    $.profileRequiredToggle('disable');
    $(this).add('img[id=toggle_billing_profile_form]').attr('src', "<%= asset_path('add_new_billing_profile.png') %>");
    $(':radio[id*='+profile_id+']').attr("checked","checked");
    profile_form_hidden = true;
  }
  if($("#funding_source_paypal, #funded_account_funding_source_paypal").is(":checked")){
    $('[name*=next],[name*=load_funds]').hide();
    $('[name*=paypal]').show();
  }
  else{
    $('[name*=next],[name*=load_funds]').show();
    $('[name*=paypal]').hide();
  }
  if($("#payment_method_paypal").is(":checked")){
    $('#credit_card_form').hide();
    $('form#new_order').attr("action", paypalCheckoutUrl());
  }
  else{
    $('#credit_card_form').show();
    if (!$('#reprocess_ucc_amount')) {
      $('form#new_order').attr("action","/orders");
    }
  }
});
$('.delete_profile').livequery(
  'ajax:beforeSend', function(){
    $(this).parent().parent().children('td').addClass('deleting');
    $(this).parent().html('<%= image_tag "ajax-loader.gif" %>');
    $(this).parent().html("");
    $(this).bind('ajax:complete', function(event, data, status, xhr){
      $('tr#billing_profile_'+$(this).attr('href').match(/\d+$/)[0]).remove();
      if($('#existing_credit_cards tr').length < 3){
        //old
        //$('tr:#existing_credit_cards_header').remove();
        $('#existing_credit_cards').remove();
        $('h3.funding_sources_head').remove();
        $('#register_card_form').fadeIn();
      }
      if(data.status==500){
        alert("Error: problems occurred and profile was not successfully deleted.");
      }
    }).bind('ajax:failure', function(event, data, status, xhr){
      alert("Error: problems occurred and profile was not successfully deleted.");
    });
});
if(profile_form_hidden == false){
  $(':radio[name*=funding_source]').removeAttr("checked");
  $(this).add('img[id=toggle_billing_profile_form]').attr('src', "<%= asset_path('hide_billing_profile_form.png') %>");
}
$(':radio[name*=funding_source]').change(function(){
  if($("#funding_source_paypal, #funded_account_funding_source_paypal").is(":checked")){
    $('[name*=next],[name*=load_funds],#credit_card_form').hide();
    $('[name*=paypal]').show();
  }
  else{
    $('[name*=next],[name*=load_funds],#credit_card_form').show();
    $('[name*=paypal]').hide();
  }
});
$(':radio[name*=payment_method]').change(function(){
  if($("#payment_method_paypal").is(":checked")){
    $('#credit_card_form').hide();
    $('form#new_order').attr("action", paypalCheckoutUrl());
  }
  else{
    $('#credit_card_form').show();
    $('form#new_order').attr("action","/orders");
  }
});