<script type="text/javascript">
  jQuery.noConflict();
  jQuery(function($) {
    $(document).ready(function () {
      $(document).on('keyup', '#email_verification_code', function() {
        if ($(this).val() == '') {
          $('.btn-email-verification').removeClass('btn-primary');
          $('.btn-email-verification').prop('disabled', true);
        } else {
          $('.btn-email-verification').addClass('btn-primary');
          $('.btn-email-verification').prop('disabled', false);
        }
      });

      $(document).on('keyup', '#phone_verification_code', function() {
        if ($(this).val() == '') {
          $('.btn-phone-verification').removeClass('btn-primary');
          $('.btn-phone-verification').prop('disabled', true);
        } else {
          $('.btn-phone-verification').addClass('btn-primary');
          $('.btn-phone-verification').prop('disabled', false);
        }
      });

      $(document).on('click', '.btn-phone-verification', function() {
        var phone_verification_url = '<%= phone_verification_check_url %>';

        $.ajax({
          url: phone_verification_url,
          data: {
            token: $('#token').val(),
            passed_token: $('#passed_token').val(),
            phone_verification_code: $('#phone_verification_code').val(),
          },
          type: 'POST',
          success: function (data) {
            if (data['status'] == 'no-user') {
              location.reload(true);
            } else {
              var message_wrap_element = $('<div></div>');
              if (data['status'] == 'success') {
                message_wrap_element.attr('class', 'flash_message notice');
              } else {
                message_wrap_element.attr('class', 'flash_message error');
              }

              var message_element = $('<span></span>');
              if (data['status'] == 'success') {
                message_element.append('Callback verification completed successfully.');
              } else if (data['status'] == 'incorrect-token') {
                message_element.append('Verification attempted with the wrong token.');
              } else if (data['status'] == 'failed') {
                message_element.append('The phone verification code what you have inputted are wrong. Please try with correct one again.');
              } else if (data['status'] == 'reached_to_max') {
                message_element.append('You have tried to do verification too many times. You need to do verification from start with new email verification code.');
              }
              message_wrap_element.append(message_element);

              var btn_element = $('<small></small>');
              var close_btn_element = $('<div></div>');
              close_btn_element.attr('class', 'close_flash_message');

              var close_sign_element = $('<span></span>');
              close_sign_element.append('X');

              close_btn_element.append(close_sign_element);
              close_btn_element.append('close');

              btn_element.append(close_btn_element);
              message_wrap_element.append(btn_element);

              if ($('#content').find('.inner').children().first().hasClass('flash_message')) {
                $('#content').find('.inner').children().first().remove();
              }
              message_wrap_element.insertBefore($('#content').find('.inner').children().first());

              if (data['status'] == 'incorrect-token') {
                $('#phone-verification-code').val('');
                $('#passed_token').val('');
                $('.btn-phone-verification').removeClass('btn-primary');
                $('.btn-phone-verification').prop('disabled', true);

                $('.phone-verification-block').hide();
                $('.phone-call-block').show();
              } else if (data['status'] == 'success' || data['status'] == 'reached_to_max') {
                $('.automated-call-verification').remove();
              } else if (data['status'] == 'failed') {
                $('#passed_token').val(data['passed_token']);
              }
            }
          }
        });
      });

      $(document).on('click', '.btn-automated-callback', function() {
        var automated_call_url = '<%= automated_call_url %>';

        $.ajax({
          url: automated_call_url,
          data: {
            token: $('#token').val(),
            method: $("input[name='method']:checked").val()
          },
          type: 'POST',
          success: function (data) {
            if (data['status'] == 'success') {
              $('#passed_token').val(data['passed_token']);
              $('.phone-call-block').hide();
              $('.phone-verification-block').show();
            } else {
              if (data['status'] == 'no-user') {
                location.reload(true);
              } else {
                var message_wrap_element = $('<div></div>');
                message_wrap_element.attr('class', 'flash_message error');

                var message_element = $('<span></span>');
                if (data['status'] == 'failed') {
                  message_element.append('Phone call attempt failed. Please try again.');
                } else if (data['status'] == 'incorrect-token') {
                  message_element.append('You need to do verification with correct verification code in email what you have received.');
                } else if (data['status'] == 'reached_to_max') {
                  message_element.append('You are trying to do call too many times. You need to do verification from start with new email verification code.');
                }
                message_wrap_element.append(message_element);

                var btn_element = $('<small></small>');
                var close_btn_element = $('<div></div>');
                close_btn_element.attr('class', 'close_flash_message');

                var close_sign_element = $('<span></span>');
                close_sign_element.append('X');

                close_btn_element.append(close_sign_element);
                close_btn_element.append('close');

                btn_element.append(close_btn_element);
                message_wrap_element.append(btn_element);

                if ($('#content').find('.inner').children().first().hasClass('flash_message')) {
                  $('#content').find('.inner').children().first().remove();
                }
                message_wrap_element.insertBefore($('#content').find('.inner').children().first());

                if (data['status'] == 'reached_to_max') {
                  $('.automated-call-verification').remove();
                }
              }
            }
          }
        });
      });

      $(document).on('click', '.btn-email-verification', function() {
        var email_verification_url = '<%= email_verification_check_url %>';

        $.ajax({
          url: email_verification_url,
          data: {
            email_verification_code: $('#email_verification_code').val()
          },
          type: "POST",
          success: function (data) {
            if (data['status'] == 'correct') {
              $('#passed_token').val(data['token']);
              $('.email-verification-block').hide();
              $('.phone-call-block').show();
            } else if (data['status'] == 'no-user') {
              location.reload(this);
            } else {
              var message_wrap_element = $('<div></div>');
              message_wrap_element.attr('class', 'flash_message error');

              var message_element = $('<span></span>');
              if (data['status'] == 'expired') {
                message_element.append('The email verification code what you have inputted has been expired. Please retry with new verification code.');
              } else if (data['status'] == 'incorrect') {
                message_element.append('The email verification code what you have inputted is incorrect. Please retry with correct one.');
              } else if (data['status'] == 'no-permission') {
                message_element.append('You have no permission to do verification.');
              }
              message_wrap_element.append(message_element);

              var btn_element = $('<small></small>');
              var close_btn_element = $('<div></div>');
              close_btn_element.attr('class', 'close_flash_message');

              var close_sign_element = $('<span></span>');
              close_sign_element.append('X');

              close_btn_element.append(close_sign_element);
              close_btn_element.append('close');

              btn_element.append(close_btn_element);
              message_wrap_element.append(btn_element);

              if ($('#content').find('.inner').children().first().hasClass('flash_message')) {
                $('#content').find('.inner').children().first().remove();
              }
              message_wrap_element.insertBefore($('#content').find('.inner').children().first());
            }
          }
        });
      });
    });
  });
</script>
