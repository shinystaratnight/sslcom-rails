-title = "User Management"
-content_for :title, title
-slug_params = {ssl_slug: @ssl_slug}
=render :partial => 'index_scripts'
%div{style: 'display:flex;justify-content:flex-end'}
  #search_bar{style: 'flex-basis:400px;margin:1.5rem;'}
    =form_tag :search_users, :id=>'search_form', :method=>:get do
      username or email or role
      =text_field_tag :search, @search
      =hidden_field_tag :per_page, @per_page
      =submit_tag 'search'
      .search-hint
        = '*e.g.: role:account_admin'
  %div{style: 'flex-basis:270px;'}
#validations
  %table(cellspacing="0")
    -if will_paginate @users
      %tfoot
        %tr
          %td.wrap_number_rows
            =select_tag :number_rows,
            options_for_select([[5, 5], [10, 10], [20, 20], [50, 50], [100, 100]], @per_page),
            :class=>'per_page'
          %td(colspan='6')=will_paginate @users
    %caption
      =title
      [learn about #{link_to "inviting users", "https://www.ssl.com/how-to/inviting-users-to-your-team/", target: "_blank"}]
      =will_paginate @users
    -unless current_user.is_system_admins?
      %tr
        =link_to 'Invite User', new_managed_user_path(slug_params), class: 'button_blue button_index'
    %tr.heading_row
      %th
      %th.name(scope="col")Username
      %th(scope="col") Email Address
      %th(scope="col") Role(s)
      -if current_user.is_system_admins?
        %th(scope="col") Created
        %th(scope="col") Last Login
        %th(scope="col") Status
      -else
        %th(scope="col") Approved
    -if current_user.is_system_admins?
      -@users.each do |u|
        -cache(['admin-list', u]) do
          -user_view = true
          -user_view ||= u!=current_user && !u.is_owner?(current_user.ssl_account)
          -type = ""
          -User.get_user_accounts_roles_names(u).each{|ssl| type << "<strong>#{ssl.first}</strong>: #{ssl.second.join(', ')}<br />"}
          -us, us_class=user_status(u)
          %tr{class: "#{user_view ? 'enable' : 'disable'}"}
            %td.dropdown= user_view ? image_tag('expand.png') : ''
            %td.name.expandable=u.login
            %td.expandable=u.email
            %td.expandable.constrained=type.html_safe
            %td.expandable=u.created_at.strftime("%b %d, %Y")
            %td.expandable=(u.last_login_at.blank?) ? "never" : u.last_login_at.strftime("%b %d, %Y")
            %td.expandable.validation_status_message(class="#{us_class}" colspan="1")=us
          %tr.hidden.expanded
            %td(colspan="6")
              .certificate_details
                =render "details", u: u
    -else
      -@users.each do |u|
        -cache(['list', u]) do
          -user_view = false
          -user_view ||= u!=current_user && !u.is_owner?(current_user.ssl_account)
          -as, as_class=ssl_account_status(u, current_user.ssl_account)
          %tr{class: "#{user_view ? 'enable' : 'disable'}"}
            %td.dropdown= user_view ? image_tag('expand.png') : ''
            %td.name.expandable=u.login
            %td.expandable=u.email
            %td.expandable="#{u.role_symbols(current_user.ssl_account).join('/')}"
            %td.expandable.validation_status_message(class="#{as_class}" colspan="1")=as
          %tr.hidden.expanded
            %td(colspan="6")
              .certificate_details
                =render "details", u: u

    -#-@users.each do |u|
    -#  -cache(['list', u]) do
    -#    -user_view = current_user.is_system_admins?
    -#    -user_view ||= u!=current_user && !u.is_owner?(current_user.ssl_account)
    -#    %tr{class: "#{user_view ? 'enable' : 'disable'}"}
    -#      %td.dropdown= user_view ? image_tag('expand.png') : ''
    -#      %td.name.expandable=u.login
    -#      %td.expandable=u.email
    -#      -if current_user.is_system_admins?
    -#        -type = ""
    -#        -User.get_user_accounts_roles_names(u).each{|ssl| type << "<strong>#{ssl.first}</strong>: #{ssl.second.join(', ')}<br />"}
    -#        %td.expandable.constrained=type.html_safe
    -#      -else
    -#        %td.expandable="#{u.role_symbols(current_user.ssl_account).join('/')}"
    -#      -if current_user.is_system_admins?
    -#        %td.expandable=u.created_at.strftime("%b %d, %Y")
    -#        %td.expandable=(u.last_login_at.blank?) ? "never" : u.last_login_at.strftime("%b %d, %Y")
    -#        -us, us_class=user_status(u)
    -#        %td.expandable.validation_status_message(class="#{us_class}" colspan="1")=us
    -#      - unless current_user.is_system_admins?
    -#        -as, as_class=ssl_account_status(u, current_user.ssl_account)
    -#        %td.expandable.validation_status_message(class="#{as_class}" colspan="1")=as
    -#      %tr.hidden.expanded
    -#        %td(colspan="6")
    -#          .certificate_details
    -#            =render "details", u: u
