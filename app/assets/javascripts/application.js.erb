// Place your application-specific JavaScript functions and classes here
// This file is automatically included by javascript_include_tag :defaults

function remove_fields(link) {
   $(link).prev("input[type=hidden]").val("1");
   $(link).closest(".fields").hide();
}

function add_fields(link, association, content) {
   var new_id = new Date().getTime();
   var regexp = new RegExp("new_" + association, "g");
   $(link).parent().before(content.replace(regexp, new_id));
}

function refreshRolesSelect(account_id) {
  var roles_list = JSON.parse($.toJSON($('#user_account_roles')
    .data('accounts-roles')))[account_id];
  if (roles_list) {
    $('#user_role_ids option:selected').removeAttr('selected');
    roles_list.forEach(function(role_id) {
      $('#user_role_ids option[value="' + role_id + '"]')
        .attr('selected', 'selected');
    });
    $("#user_role_ids").select2();
  }
}

function adjust_funds_ssl_account(ssl_slug, team_name)
{
  var amount = prompt("Amount to adjust for team "+team_name+" (in USD)?", '');
  if (amount == null || amount=="")
    return;
  else
    window.location = '/team/'+ssl_slug+'/ssl_account/adjust_funds?amount='+encodeURIComponent(amount);
}

$.ajaxSettings.dataType = "json";

jQuery(function($) {
  var flash_notice = $('.flash_message.notice span');
  $('#user_ssl_account_id').on('change', function() {
    refreshRolesSelect($(this).val());
  });
  if (flash_notice.length && flash_notice.text().indexOf('been added to account') > -1) {
    $('.simple-tooltip-cont, .simple-tooltip').removeClass('hidden');
  }
  if ($('.notifications-alert').length) {
    $('.notifications-alert, .notifications-email').on('click', function() {
      $('.notifications-expand').toggle('slow');
    });
  }

  // Toggle role checkboxes: cannot select both account_admin/owner and other roles.
  function update_checkbox(checkbox_ids, update_type) {
    $.each( $(checkbox_ids), function(key, checkbox) {
      var cur = $('#'+checkbox.id);
      cur.prop('checked', (update_type == 'check'));
    });
  }

  if ($('#mu_update_roles, #mu_invite_user').length) {
    var role_ignore = ['role_sysadmin', 'role_super_user', 'role_reseller'],
        role_ids    = $('#mu_update_roles, #mu_invite_user')
          .find('input[type=checkbox]').map(function(){return this.id}).get().join(', #').replace(/^/gm, '#');
    $.each(role_ignore, function(key, value) {
      role_ids = role_ids.replace(['#',$('#'+value+' input').attr('id'),','].join(''), '');
    });

    $(role_ids).on('change', function() {
      var target_id = $(this).parent().attr('id');
      if (target_id == 'role_account_admin' || target_id == 'role_owner'){
        update_checkbox(role_ids, 'uncheck');
        update_checkbox('#'+this.id, 'check');
      } else {
        update_checkbox('#role_account_admin input, #role_owner input', 'uncheck');
      }
    });
  }

  $('.flash_message_more .more span').on('click', function() {
    $.get($('.close_flash_message.more').data('dont-show'));
    $('.flash_message_more').remove();
  });

  $(document).on('click', '.flash_message .close_flash_message', function() {
    var message_element = $(this).parent().parent();
    if (message_element[0]) {
      message_element.remove();
    }
  });

  $('#activate_user').submit(function(e) {
    if (!$('input#tos').is(':checked')) {
      $('input#tos').css('outline', '2px solid red');
      e.preventDefault();
    }
  });

  $('#sign_up_account').submit(function(e) {
    if ($('input#tos').length > 0 && !$('input#tos').is(':checked')) {
      $('input#tos').css('outline', '2px solid red');
      e.preventDefault();
    }
  });

  // Tagging Functionality
  settings = { tags: true };
  $('#tags_list').select2(settings);
  $('#tags-cc-input #tags_list').select2(settings);

  $('#tags-container form').on('change', function() {
    $(this).submit();
  });

  // Transfer Teams
  $('#btn-teams-search').on('click', function(e) {
    e.preventDefault();
    $.ajax({
      type: 'GET',
      url: $('#frm-team-search').attr('action'),
      data: $('#frm-team-search').serialize(),
      dataType: 'JSON'
    }).success(function(json) {
      if (json.error) {
        $('#team-search-results').html(json.error);
        $('.ui-dialog-buttonset button:last-child').hide();
      } else {
        $('#team-search-results').html(json.content);
        $('.ui-dialog-buttonset button:last-child').show();
      }
    });
  });

  // Certificate Management
  $('#btn_pvi_update_item, #btn_pvi_create_item').on('click', function(e) {
    e.preventDefault();
    form = $(this).parents('form');
    form.find('#manage_type').val(
      $(this).attr('id').replace('btn_pvi_', '')
    );
    form.submit();
  });

  $('#lnk-pvg-open-form, #btn-cert-pvg-cancel').on('click', function(e) {
    e.preventDefault();
    if ($(this).attr('id') == 'lnk-pvg-open-form') {
      $('#frm-cert-edit').hide();
      $('#frm-cert-pvg-create').show();
      $('#frm-cert-pvg-create .certificate-fields certificate-fields-top').focus();
    } else {
      $('#frm-cert-edit').show();
      $('#frm-cert-pvg-create').hide();
    }
  });

  $('#new_certificate #btn-certificate-submit, .edit_certificate #btn-certificate-submit').on('click', function(e) {
    console.log('Submit');
    e.preventDefault();
    form = $(this).parents('form');

    form.find('#certificate_display_order').val(
      JSON.stringify({
        all: form.find('#all').val(),
        index: form.find('#index').val()
      })
    );
    form.find('#certificate_description').val(
      JSON.stringify({
        certificate_type: form.find('#certificate_type').val(),
        points: form.find('#points').val(),
        validation_level: form.find('#validation_level').val(),
        summary: form.find('#summary').val(),
        abbr: form.find('#abbr').val()
      })
    );
    form.submit();
  });

  // Teams Index, Saved Contacts Index
  $('.team-sel-billing-method, .team-sel-no-limit, .btn-reg-update-status, .team-sel-epki-switch').on('change', function() {
    $(this).parent().submit();
  });
});
